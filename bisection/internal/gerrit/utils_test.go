// Copyright 2022 The LUCI Authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package gerrit

import (
	"context"
	"testing"
	"time"

	"google.golang.org/protobuf/types/known/timestamppb"

	"go.chromium.org/luci/common/clock"
	"go.chromium.org/luci/common/clock/testclock"
	gerritpb "go.chromium.org/luci/common/proto/gerrit"
	"go.chromium.org/luci/common/testing/ftt"
	"go.chromium.org/luci/common/testing/truth/assert"
	"go.chromium.org/luci/common/testing/truth/should"
	"go.chromium.org/luci/gae/impl/memory"
)

func TestGetHost(t *testing.T) {
	t.Parallel()
	ctx := context.Background()

	ftt.Run("Empty string returns error", t, func(t *ftt.Test) {
		host, err := GetHost(ctx, "")
		assert.Loosely(t, err, should.ErrLike("could not find Gerrit host"))
		assert.Loosely(t, host, should.BeEmpty)
	})

	ftt.Run("Non-URL format returns error", t, func(t *ftt.Test) {
		host, err := GetHost(ctx, "[Test] This is a review title, not a URL")
		assert.Loosely(t, err, should.ErrLike("could not find Gerrit host"))
		assert.Loosely(t, host, should.BeEmpty)
	})

	ftt.Run("Gets host from review URL", t, func(t *ftt.Test) {
		host, err := GetHost(ctx, " https://chromium-test-review.googlesource.com/c/proj/+/1200003\n")
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, host, should.Equal("chromium-test-review.googlesource.com"))
	})
}

func TestHasLUCIBisectionComment(t *testing.T) {
	t.Parallel()
	ctx := memory.Use(context.Background())

	ftt.Run("No comments", t, func(t *ftt.Test) {
		hasLBComment, err := HasLUCIBisectionComment(ctx, &gerritpb.ChangeInfo{})
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, hasLBComment, should.Equal(false))
	})

	ftt.Run("No LUCI Bisection comment", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Messages: []*gerritpb.ChangeMessageInfo{
				{
					Id:      "19283",
					Message: "Automated message from Gerrit with no author",
					Tag:     "autogenerated:gerrit:test",
				},
				{
					Id: "19284",
					Author: &gerritpb.AccountInfo{
						Name:      "John Doe",
						Email:     "jdoe@example.com",
						Username:  "jdoe",
						AccountId: 100001,
					},
				},
			},
		}
		hasLBComment, err := HasLUCIBisectionComment(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, hasLBComment, should.Equal(false))
	})

	ftt.Run("LUCI Bisection has commented", t, func(t *ftt.Test) {
		// Get the service account email value in this test context
		testEmail, err := ServiceAccountEmail(ctx)
		assert.Loosely(t, err, should.BeNil)

		change := &gerritpb.ChangeInfo{
			Messages: []*gerritpb.ChangeMessageInfo{
				{
					Id:      "19285",
					Message: "Automated message from Gerrit with no author",
					Tag:     "autogenerated:gerrit:test",
				},
				{
					Id: "19286",
					Author: &gerritpb.AccountInfo{
						Name:      "LUCI Bisection",
						Email:     testEmail,
						Username:  "gae_service_account",
						AccountId: 900009,
					},
				},
				{
					Id: "19287",
					Author: &gerritpb.AccountInfo{
						Name:      "John Doe",
						Email:     "jdoe@example.com",
						Username:  "jdoe",
						AccountId: 100001,
					},
				},
			},
		}
		hasLBComment, err := HasLUCIBisectionComment(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, hasLBComment, should.Equal(true))
	})
}

func TestIsOwnedByLUCIBisection(t *testing.T) {
	t.Parallel()
	ctx := memory.Use(context.Background())

	ftt.Run("No owner", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project: "chromium/test/src",
			Number:  615243,
		}
		lbOwned, err := IsOwnedByLUCIBisection(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, lbOwned, should.Equal(false))
	})

	ftt.Run("Change is not owned by LUCI Bisection", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project: "chromium/test/src",
			Number:  615243,
			Owner: &gerritpb.AccountInfo{
				Name:      "John Doe",
				Email:     "jdoe@example.com",
				Username:  "jdoe",
				AccountId: 100001,
			},
		}
		lbOwned, err := IsOwnedByLUCIBisection(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, lbOwned, should.Equal(false))
	})

	ftt.Run("Change is owned by LUCI Bisection", t, func(t *ftt.Test) {
		// Get the service account email value in this test context
		testEmail, err := ServiceAccountEmail(ctx)
		assert.Loosely(t, err, should.BeNil)

		change := &gerritpb.ChangeInfo{
			Project: "chromium/test/src",
			Number:  615243,
			Owner: &gerritpb.AccountInfo{
				Name:      "LUCI Bisection",
				Email:     testEmail,
				Username:  "gae_service_account",
				AccountId: 900009,
			},
		}
		lbOwned, err := IsOwnedByLUCIBisection(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, lbOwned, should.Equal(true))
	})
}

func TestIsRecentSubmit(t *testing.T) {
	t.Parallel()
	ctx := context.Background()

	// Set test clock
	cl := testclock.New(testclock.TestTimeUTC)
	ctx = clock.Set(ctx, cl)

	ftt.Run("IsRecentSubmit", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project: "chromium/test/src",
			Number:  234567,
		}
		maxAge := time.Duration(6) * time.Hour

		t.Run("change submitted now is recent", func(t *ftt.Test) {
			change.Submitted = timestamppb.New(clock.Now(ctx))
			assert.Loosely(t, IsRecentSubmit(ctx, change, maxAge), should.Equal(true))
		})

		t.Run("change submitted at threshold time is recent", func(t *ftt.Test) {
			change.Submitted = timestamppb.New(clock.Now(ctx).Add(-time.Hour * 6))
			assert.Loosely(t, IsRecentSubmit(ctx, change, maxAge), should.Equal(true))
		})

		t.Run("change submitted a while ago is not recent", func(t *ftt.Test) {
			change.Submitted = timestamppb.New(clock.Now(ctx).Add(-time.Hour * 30))
			assert.Loosely(t, IsRecentSubmit(ctx, change, maxAge), should.Equal(false))
		})
	})
}

func TestHasAutoRevertOffFlagSet(t *testing.T) {
	t.Parallel()
	ctx := context.Background()

	ftt.Run("change does not have enough information", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project: "chromium/test/src",
			Number:  234567,
		}
		_, err := HasAutoRevertOffFlagSet(ctx, change)
		assert.Loosely(t, err, should.ErrLike("could not get"))
		assert.Loosely(t, err, should.ErrLike("info"))
	})

	ftt.Run("change does not mention flag", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project:         "chromium/test/src",
			Number:          234567,
			CurrentRevision: "deadbeef",
			Revisions: map[string]*gerritpb.RevisionInfo{
				"deadbeef": {
					Number: 1,
					Kind:   gerritpb.RevisionInfo_REWORK,
					Uploader: &gerritpb.AccountInfo{
						AccountId:       1000096,
						Name:            "John Doe",
						Email:           "jdoe@example.com",
						SecondaryEmails: []string{"johndoe@chromium.org"},
						Username:        "jdoe",
					},
					Ref:         "refs/changes/123",
					Description: "first upload",
					Files: map[string]*gerritpb.FileInfo{
						"go/to/file.go": {
							LinesInserted: 32,
							LinesDeleted:  44,
							SizeDelta:     -567,
							Size:          11984,
						},
					},
					Commit: &gerritpb.CommitInfo{
						Id:      "",
						Message: "Title.\n\nBody is here.\n\nChange-Id: I100deadbeef",
						Parents: []*gerritpb.CommitInfo_Parent{
							{Id: "deadbeef00"},
						},
					},
				},
			},
		}

		hasFlag, err := HasAutoRevertOffFlagSet(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, hasFlag, should.Equal(false))
	})

	ftt.Run("change has flag set", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project:         "chromium/test/src",
			Number:          234567,
			CurrentRevision: "deadbeef",
			Revisions: map[string]*gerritpb.RevisionInfo{
				"deadbeef": {
					Number: 1,
					Kind:   gerritpb.RevisionInfo_REWORK,
					Uploader: &gerritpb.AccountInfo{
						AccountId:       1000096,
						Name:            "John Doe",
						Email:           "jdoe@example.com",
						SecondaryEmails: []string{"johndoe@chromium.org"},
						Username:        "jdoe",
					},
					Ref:         "refs/changes/123",
					Description: "first upload",
					Files: map[string]*gerritpb.FileInfo{
						"go/to/file.go": {
							LinesInserted: 32,
							LinesDeleted:  44,
							SizeDelta:     -567,
							Size:          11984,
						},
					},
					Commit: &gerritpb.CommitInfo{
						Id:      "",
						Message: "Title.\n\nBody is here.\n\nNOAUTOREVERT=true\n\nChange-Id: I100deadbeef",
						Parents: []*gerritpb.CommitInfo_Parent{
							{Id: "deadbeef00"},
						},
					},
				},
			},
		}

		hasFlag, err := HasAutoRevertOffFlagSet(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, hasFlag, should.Equal(true))
	})

	ftt.Run("change has flag set with extra whitespace", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project:         "chromium/test/src",
			Number:          234567,
			CurrentRevision: "deadbeef",
			Revisions: map[string]*gerritpb.RevisionInfo{
				"deadbeef": {
					Number: 1,
					Kind:   gerritpb.RevisionInfo_REWORK,
					Uploader: &gerritpb.AccountInfo{
						AccountId:       1000096,
						Name:            "John Doe",
						Email:           "jdoe@example.com",
						SecondaryEmails: []string{"johndoe@chromium.org"},
						Username:        "jdoe",
					},
					Ref:         "refs/changes/123",
					Description: "first upload",
					Files: map[string]*gerritpb.FileInfo{
						"go/to/file.go": {
							LinesInserted: 32,
							LinesDeleted:  44,
							SizeDelta:     -567,
							Size:          11984,
						},
					},
					Commit: &gerritpb.CommitInfo{
						Id:      "",
						Message: "Title.\n\nBody is here.\n\nNOAUTOREVERT\t=   true\n\nChange-Id: I100deadbeef",
						Parents: []*gerritpb.CommitInfo_Parent{
							{Id: "deadbeef00"},
						},
					},
				},
			},
		}

		hasFlag, err := HasAutoRevertOffFlagSet(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, hasFlag, should.Equal(true))
	})

	ftt.Run("change has flag set to false", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project:         "chromium/test/src",
			Number:          234567,
			CurrentRevision: "deadbeef",
			Revisions: map[string]*gerritpb.RevisionInfo{
				"deadbeef": {
					Number: 1,
					Kind:   gerritpb.RevisionInfo_REWORK,
					Uploader: &gerritpb.AccountInfo{
						AccountId:       1000096,
						Name:            "John Doe",
						Email:           "jdoe@example.com",
						SecondaryEmails: []string{"johndoe@chromium.org"},
						Username:        "jdoe",
					},
					Ref:         "refs/changes/123",
					Description: "first upload",
					Files: map[string]*gerritpb.FileInfo{
						"go/to/file.go": {
							LinesInserted: 32,
							LinesDeleted:  44,
							SizeDelta:     -567,
							Size:          11984,
						},
					},
					Commit: &gerritpb.CommitInfo{
						Id:      "",
						Message: "Title.\n\nBody is here.\n\nNOAUTOREVERT=false SOMEOTHERFLAG=true\n\nChange-Id: I100deadbeef",
						Parents: []*gerritpb.CommitInfo_Parent{
							{Id: "deadbeef00"},
						},
					},
				},
			},
		}

		hasFlag, err := HasAutoRevertOffFlagSet(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, hasFlag, should.Equal(false))
	})
}

func TestAuthorEmail(t *testing.T) {
	t.Parallel()
	ctx := context.Background()

	ftt.Run("change does not have enough information", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project: "chromium/test/src",
			Number:  234567,
		}
		_, err := AuthorEmail(ctx, change)
		assert.Loosely(t, err, should.ErrLike("could not get"))
		assert.Loosely(t, err, should.ErrLike("info"))
	})

	ftt.Run("change does not have an author", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project:         "chromium/test/src",
			Number:          234567,
			CurrentRevision: "deadbeef",
			Revisions: map[string]*gerritpb.RevisionInfo{
				"deadbeef": {
					Number: 1,
					Kind:   gerritpb.RevisionInfo_REWORK,
					Uploader: &gerritpb.AccountInfo{
						AccountId:       1000096,
						Name:            "John Doe",
						Email:           "jdoe@example.com",
						SecondaryEmails: []string{"johndoe@chromium.org"},
						Username:        "jdoe",
					},
					Ref:         "refs/changes/123",
					Description: "first upload",
					Files: map[string]*gerritpb.FileInfo{
						"go/to/file.go": {
							LinesInserted: 32,
							LinesDeleted:  44,
							SizeDelta:     -567,
							Size:          11984,
						},
					},
					Commit: &gerritpb.CommitInfo{
						Id:      "",
						Message: "Title.\n\nBody is here.\n\nChange-Id: I100deadbeef",
						Parents: []*gerritpb.CommitInfo_Parent{
							{Id: "deadbeef00"},
						},
					},
				},
			},
		}

		_, err := AuthorEmail(ctx, change)
		assert.Loosely(t, err, should.ErrLike("no author in commit info"))
	})

	ftt.Run("author email is returned", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project:         "chromium/test/src",
			Number:          234567,
			CurrentRevision: "deadbeef",
			Revisions: map[string]*gerritpb.RevisionInfo{
				"deadbeef": {
					Number: 1,
					Kind:   gerritpb.RevisionInfo_REWORK,
					Uploader: &gerritpb.AccountInfo{
						AccountId:       1000096,
						Name:            "John Doe",
						Email:           "jdoe@example.com",
						SecondaryEmails: []string{"johndoe@chromium.org"},
						Username:        "jdoe",
					},
					Ref:         "refs/changes/123",
					Description: "first upload",
					Files: map[string]*gerritpb.FileInfo{
						"go/to/file.go": {
							LinesInserted: 32,
							LinesDeleted:  44,
							SizeDelta:     -567,
							Size:          11984,
						},
					},
					Commit: &gerritpb.CommitInfo{
						Id:      "",
						Message: "Title.\n\nBody is here.\n\nNOAUTOREVERT=true\n\nChange-Id: I100deadbeef",
						Parents: []*gerritpb.CommitInfo_Parent{
							{Id: "deadbeef00"},
						},
						Author: &gerritpb.GitPersonInfo{
							Name:  "John Doe",
							Email: "jdoe@example.com",
						},
					},
				},
			},
		}

		author, err := AuthorEmail(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, author, should.Equal("jdoe@example.com"))
	})
}

func TestCommitMessage(t *testing.T) {
	t.Parallel()
	ctx := context.Background()

	ftt.Run("change does not have enough information", t, func(t *ftt.Test) {
		change := &gerritpb.ChangeInfo{
			Project: "chromium/test/src",
			Number:  234567,
		}
		_, err := CommitMessage(ctx, change)
		assert.Loosely(t, err, should.ErrLike("could not get"))
		assert.Loosely(t, err, should.ErrLike("info"))
	})

	ftt.Run("commit message is returned", t, func(t *ftt.Test) {
		expectedMessage := "Title.\n\nBody is here.\n\nNOAUTOREVERT=true\n\nChange-Id: I100deadbeef"
		change := &gerritpb.ChangeInfo{
			Project:         "chromium/test/src",
			Number:          234567,
			CurrentRevision: "deadbeef",
			Revisions: map[string]*gerritpb.RevisionInfo{
				"deadbeef": {
					Number: 1,
					Kind:   gerritpb.RevisionInfo_REWORK,
					Uploader: &gerritpb.AccountInfo{
						AccountId:       1000096,
						Name:            "John Doe",
						Email:           "jdoe@example.com",
						SecondaryEmails: []string{"johndoe@chromium.org"},
						Username:        "jdoe",
					},
					Ref:         "refs/changes/123",
					Description: "first upload",
					Files: map[string]*gerritpb.FileInfo{
						"go/to/file.go": {
							LinesInserted: 32,
							LinesDeleted:  44,
							SizeDelta:     -567,
							Size:          11984,
						},
					},
					Commit: &gerritpb.CommitInfo{
						Id:      "",
						Message: expectedMessage,
						Parents: []*gerritpb.CommitInfo_Parent{
							{Id: "deadbeef00"},
						},
						Author: &gerritpb.GitPersonInfo{
							Name:  "John Doe",
							Email: "jdoe@example.com",
						},
					},
				},
			},
		}

		message, err := CommitMessage(ctx, change)
		assert.Loosely(t, err, should.BeNil)
		assert.Loosely(t, message, should.Equal(expectedMessage))
	})
}
